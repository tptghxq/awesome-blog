{% extends '__base__.html' %}

{% block title %}{{ blog.name }}{% endblock %}

{% block beforehead %}

<script>

var comment_url = '/api/blogs/{{ blog.id }}/comments';
$(function () {


  
    var article = new Vue({
        el:'#article',data:{
            like_num:'{{blog.like_num}}',
            likestate:{{blog.likestate}}
        },
        methods:{
            addLikeBlog:function(blogid){
            if (!'{{__user__.id}}'||('{{__user__.id}}'=='{{blog.user_id}}')) {
                return 
            }
                $like=$('.likebutton');          
            $like.addClass('disabled');
            that=this;
            postJSON('/api/likeblog',{blog_id:blogid},function(err,r){
            $like.removeClass('disabled');
            if(err){
                showInfo(err);
            }else{
                that.likestate=r.likestate;
                that.like_num=r.like_num;              
            }
        });}
        }
    });

 {% if __user__ %}
var pushcomment = new Vue({
    el:'#pushcomment',
    data:{username:''},
    ready:function(){
        this.username='{{__user__.name}}';
        if(!this.username){
            return
         
        } 
    var editor =new wangEditor('commentArea');
    editor.config.menus = [
        'bold',
        'underline',
        'italic',
        'strikethrough',
        'eraser',
        'forecolor',
        '|',
        'quote',
        'fontfamily',
        'fontsize',
        'head',
        'unorderlist',
        'orderlist',
        'alignleft',
        'aligncenter',
        'alignright',
        '|',
        'link',
        'unlink',
        'emotion',
        '|',
        'img',
        'insertcode',
        '|',
        'undo',
        'redo',
    ];
    //让输入框跟随编辑器div同步变化，才能使用at
        editor.onchange=function(){
        $edit=$('#commentArea');
        $edit.val(this.$txt.html());
    };
    editor.config.menuFixed = false;
        editor.config.emotions={
        'default':{
            title:'默认',
            data:'../../static/emotions/emotions.data'
        }
    };
editor.create();
    editor.$txt.atwho({
  at: "@",
  limit:6,
  callbacks: {    
    remoteFilter: function(query, callback) {
      $.getJSON("/getmentions", {term: query}, function(data) {
        callback(data.usernames)
      });
    }
  }
});

    },
    methods:{
        submit:function (e) {
            var $form = $('#form-comment');
        e.preventDefault();
        var content = $form.find('textarea').val().trim();
        if (content==='') {
         return showInfo('请输入评论内容！',1);
        }var searchlib=[];
            var atNameAndIds=[];
            var $content=$('<div>'+content+'</div>');
            $content.find('.atwho-inserted').each(function(i,e){
                var atNameAndId={};
                
                var name = $(e).text().slice(1);
                 //去除重复@@
                if(atNameAndIds.length){
                for(var i in atNameAndIds){
                if  (atNameAndIds[i]['name']==name) {
                    $(e).remove;
                   return
                }
                }  
                }
                var uuid = generateUUID();
                atNameAndId['name']=name;
                atNameAndId['uuid']=uuid;
                atNameAndIds.push(atNameAndId);                         
                $(e).wrap("<a id='"+uuid+"' href='/user/"+name+"'></a>");
            });
            var content2=$content.html();

        $form.postJSON(comment_url, { content: content2,atNameAndIds:atNameAndIds }, function (err, result) {
            if (!err) {
               location.reload();
            }
            
        });
        
    }
    }
});
     {% endif%}
  
Vue.component('doagree',{
    data:function(){
         return {
            agreestate:this.agreestate2,
            agreenum:this.agreenum2,
            disagreenum:this.disagreenum2,
         }
        },
    props:['agreestate2','commentid','agreenum2','disagreenum2'],
    template:'<div class="agreebox"><i class="fa fa-sort-up triangleup" :class="{upactive:agreestate==1}" v-on:click="opagree(1,$event)"></i><div v-text="agreenum"></div><div v-text="disagreenum"></div><i class="fa fa-sort-desc triangledown" :class="{downactive:agreestate==-1}" v-on:click="opagree(-1,$event)"></i></div>',
    methods:{
    opagree:function(op,event){
    $(event.target).addClass('disabled'); 
            that=this;
    postJSON('/api/agree',{comment_id:that.commentid,op:op},function(err,r){
        $(event.target).removeClass('disabled');
        if(err){showInfo(err);}
        else{
           that.agreenum=r.agreenum;
           that.agreestate=r.agreestate;
           that.disagreenum=r.disagreenum;
    }
    });
    }
    }
});

var agreeappli =new Vue({
    el:'#allcomment'
});

    var boo = new Vue({
  el: '.bookmark',data:{
    bookmarks:[],
    bookmarksnum:0,
    togglestate:0,
    movelongth:''
  },
  ready:function(){
    this.dropbookmarks();
    this.bookmarksnum=this.bookmarks.length;
    $bookmark=$('.bookmark');
      if(this.bookmarksnum){
   setTimeout(function(){
    this.movelongth =$bookmark.width()+$bookmark.css('padding-left').slice(0,-2)*2+5;
     $bookmark.css('left','-'+this.movelongth+'px');
     $bookmark.css('visibility','visible');
     scrolltip('.bookmark a');
   
},200) ;
 }
    
  },
  methods:{ //methods不要忘记's'
    dropbookmarks:function(){
        that=this;
        $('.maincontent').find(':header').each(function(i,e){
            var bookmark = {};
            bookmark.text=$(e).text();
            bookmark.size=$(e).get(0).tagName;
            that.bookmarks.push(bookmark);

        });
    },marktoggle:function(){
        this.togglestate=!this.togglestate;
        if(!this.togglestate){
            $('.bookmark').animate({left:'-'+movelongth+'px'},100);
        }
        else{
            $('.bookmark').animate({left:'0px'},300);
        }
    }

  }
});

var splipage = new Vue({
  el: '.pagination',
  data:{pageCodes:''}
  ,
      ready:function(){

     this.getPageCodes('{{page.page_index}}','{{page.page_count}}');
      },methods:{
          gotoPage:function(pageCode){
            if(pageCode=='{{page.page_index}}'){
                return;
            }
            gotoPage(pageCode);
        },      
        getPageCodes: function(index,count) {
                    this.pageCodes=getPageCodes(index,count);
            },
      }
}); 
}); 
  
</script>

{% endblock %}

{% block content %}

<div class="uk-width-medium-3-5 oneblog">
<ul class="bookmark"><li v-for="bookmark in bookmarks"><span><i class="fa fa-bookmark"></i></span><a :href="'#tip'+$index" :class="{h1tag:bookmark.size=='H1',h2tag:bookmark.size=='H2',h3tag:bookmark.size=='H3',h4tag:bookmark.size=='H4',h5tag:bookmark.size=='H5',h6tag:bookmark.size=='H6'}" v-text="bookmark.text"></a></li><div class="marktoggle" v-on:click="marktoggle"><i class="fa" :class="togglestate?'fa-angle-double-left':'fa-angle-double-right'"></i></div></ul>



        <article id="article">

        <h2><span class="fragment">{{ blog.name }}</span>
        {% if __user__.admin or __user__.id==blog.user_id %}   
             <a class="fragment" onclick="deleteItem({{blog}})" href="javascript:void(0)"><i class="fa fa-trash"></i></a> 
             <a class="fragment" href="/manage/blogs/edit?id={{blog.id}}"><i class="fa fa-edit"></i></a>
             {% endif %}</h2>  
          <div class="frags">   
          <span class="fragment author"><a href="/user/{{blog.user_name}} ">{{ blog.user_name }}</a></span><span class="fragment smarttime">{{ blog.created_at|datetime }}</span>
                {% if blog.update_at %}
                    <span class="fragment smarttime">更新于{{ blog.update_at|datetime}}</span>

                {% endif %}
                <span class="fragment"><i class="fa fa-heart" :class="likestate?'redlikebutton':'likebutton'" v-on:click="addLikeBlog('{{blog.id}}',2)"></i><span class="num" v-text="like_num"></span></span><span class="fragment"><i class="fa fa-eye"></i><span class="num">{{blog.read_num}}</span></span>
             
        </div>
<div class="blogcontent"><div class="maincontent">{{ blog.content|safe }}</div>

<div class="footer">  
<div class="tagboxs">
{% for tagname in tagnames %}
<span class="tagbox">
<i class="fa fa-tag"></i>
<a href="/user/{{blog.user_name}}/tag/{{tagname}}"><span class="tag">{{tagname}}</span></a>
</span>
{% endfor %}

</div>
    <div class="jiathis">
    <a class="jiathis_txt"><i class="fa fa-share"></i></a>
    <ul>
    <li><a class="jiathis_button_tsina"><i class="fa fa-weibo"></i></a></li>
    <li><a class="jiathis_button_tqq"><i class="fa fa-weixin"></i></a></li>
    <li><a class="jiathis_button_renren"><i class="fa fa-renren"></i></a></li>
    <li><a class="jiathis_button_cqq"><i class="fa fa-qq"></i></a></li>
    </ul> 
</div>
</div>
</div>
        </article>
        
 {% if __user__ %}
  <hr class="uk-article-divider">
        <article id="pushcomment" class="uk-comment">
            <div class="uk-comment-header">
                <div class="commentuser"><img class="round" src="{{ __user__.image }}">
                <h3 class="uk-comment-title">{{ __user__.name }}</h3> </div>
                           <div class="uk-comment-body">
                <form id="form-comment" v-on:submit="submit" class="uk-form">
                
                    <div class="uk-form-row">
                        <textarea id="commentArea" rows="6" placeholder="说点什么吧" style="width:100%;resize:none;border-radius:0;"></textarea>
                    </div>
                    <div class="uk-form-row">
                        <button type="submit" class="recbutton"><i class="fa fa-send"></i></button>
                    </div>
                </form>
            </div>
            </div>

        </article>
   {% endif %}

      <div class="comentnav"><h3><i class="fa fa-comments"></i>最新评论</h3></div>   
       <ul id="allcomment" class="uk-comment-list">
            {% for comment in comments %}
            <li id="{{comment.id}}">
            <!-- 评论书签 -->

                <article class="uk-comment">
 <doagree name="agreebox" agreestate2="{{comment.agreestate}}" agreenum2="{{comment.agree_num}}" disagreenum2="{{comment.disagree_num}}" commentid="{{comment.id}}"></doagree>
                <a name="{{comment.id}}" class="disabled" href="javascript:void(0)"></a>
                    <header class="uk-comment-header comment-header">
                    <a href="/user/{{comment.user_name}}">
                        <img class="round" style="width:55px;height:55px;margin-right:1em" src="{{ comment.user_image }}"></a>
                        <h4 class="uk-comment-title"><span>{{ comment.user_name }} {% if comment.user_id==blog.user_id %}<span class="authoricon">(作者)</span>{% endif %} </span><span class="smarttime">{{ comment.created_at|datetime }}</span></h4>{% if __user__.admin or comment.user_id==__user__.id %}<a class="delete" style="position:absolute;right:1em;bottom:0.5em;" onclick="deleteItem({{comment}})" href="javascript:void(0)"><i class="fa fa-trash"></i></a>{% endif %}
                
                    </header>
                    
                    <div class="comment-body">
                        {{ comment.content|safe }}
                    </div>
                    
                        
                </article>
                
            </li>
            {% else %}
            <p>暂时还没有人评论</p>
            {% endfor %}

        </ul>
 
   <!--      <ul id="allcomment" class="uk-comment-list">
            <li v-for="comment in comments" :id="comment.id">
                <article class="uk-comment">
 <doagree name="agreebox" :agreestate2="comment.agreestate" :agreenum2="comment.agree_num" :disagreenum2="comment.disagree_num" :commentid="comment.id"></doagree>
                <a :name="comment.id" class="disabled" href="javascript:void(0)"></a>
                    <header class="uk-comment-header comment-header">
                    <a :href="'/user/'+comment.user_name">
                        <img class="round" style="width:55px;height:55px;margin-right:1em" :src="comment.user_image"></a>
                        <h4 class="uk-comment-title"><span><span v-text="comment.user_name"></span><span v-if="comment.user_id=='{{blog.user_id}}'" class="authoricon">(作者)</span></span><span class="smarttime" v-text="comment.created_at"></span></h4><a v-if="'{{__user__.admin}}' || comment.user_id=='{{__user__.id}}'" class="delete" style="position:absolute;right:1em;bottom:0.5em;" v-on:click="deleteItem(comment)" href="javascript:void(0)"><i class="fa fa-trash"></i></a>     
                    </header>         
                    <div v-html="comment.content" class="comment-body">
                    </div>
                        
                </article>
                
            </li>
            <p v-else>暂时还没有人评论</p>
        </ul> -->
                <ul class="pagination">
            <li v-for="pageCode in pageCodes"><a :class="pageCode=={{page.page_index}}?'active':''" href="javascript:void(0)" v-on:click="gotoPage(pageCode)" v-text="pageCode"></a></li>
        </ul>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
{% endblock %}
